<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Arrival Notifier</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; min-height: 100vh; background: #f8f9fb; }

    /* ‚îÄ‚îÄ Mode Select Screen ‚îÄ‚îÄ */
    .mode-select {
      min-height: 100vh;
      background: linear-gradient(135deg, #f8f9fb 0%, #e8ecf4 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }
    .mode-select .logo { font-size: 48px; margin-bottom: 16px; }
    .mode-select h1 {
      font-size: 28px; font-weight: 700; color: #1a1a2e;
      margin-bottom: 6px; text-align: center; letter-spacing: -0.5px;
    }
    .mode-select .subtitle {
      color: #888; margin-bottom: 40px; text-align: center;
      max-width: 400px; line-height: 1.5;
    }
    .reception-btn {
      width: 100%; max-width: 420px; padding: 22px 28px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white; border: none; border-radius: 16px;
      font-size: 17px; font-weight: 700; cursor: pointer;
      font-family: 'DM Sans', sans-serif; margin-bottom: 16px;
      display: flex; align-items: center; gap: 14px;
      box-shadow: 0 8px 30px rgba(26,26,46,0.25);
      transition: transform 0.15s;
    }
    .reception-btn:hover { transform: scale(1.02); }
    .reception-btn .icon { font-size: 24px; }
    .reception-btn .label { text-align: left; }
    .reception-btn .sublabel { font-size: 12px; opacity: 0.6; font-weight: 400; margin-top: 2px; }

    .divider {
      display: flex; align-items: center; gap: 16px;
      width: 100%; max-width: 420px; margin: 8px 0;
    }
    .divider span { font-size: 12px; color: #bbb; }
    .divider::before, .divider::after {
      content: ''; flex: 1; height: 1px; background: #ddd;
    }

    .therapist-select { width: 100%; max-width: 420px; margin-top: 8px; }
    .therapist-select .heading {
      font-size: 13px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 1px; color: #999; margin-bottom: 16px; text-align: center;
    }
    .group-label {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
      color: #bbb; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .group-label .emoji { font-size: 14px; }
    .group-grid {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 8px; margin-bottom: 16px;
    }
    .name-btn {
      padding: 14px 8px; border-radius: 12px; cursor: pointer;
      font-size: 13px; font-weight: 600; font-family: 'DM Sans', sans-serif;
      transition: all 0.15s; border-width: 2px; border-style: solid;
    }
    .name-btn:hover { transform: scale(1.05); }

    /* ‚îÄ‚îÄ Reception Dashboard ‚îÄ‚îÄ */
    .reception-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      padding: 28px 32px; color: white;
    }
    .reception-header h1 {
      margin: 0; font-size: 24px; font-weight: 700; letter-spacing: -0.5px;
    }
    .reception-header .sub {
      margin: 0; opacity: 0.6; font-size: 14px; margin-left: 40px;
    }
    .reception-body { padding: 24px; max-width: 900px; margin: 0 auto; }

    .input-row {
      display: flex; gap: 12px; margin-bottom: 24px;
      align-items: center; flex-wrap: wrap;
    }
    .input-row .field { flex: 1; min-width: 240px; }
    .input-row label {
      display: block; font-size: 12px; font-weight: 600;
      text-transform: uppercase; letter-spacing: 1px;
      color: #666; margin-bottom: 6px;
    }
    .input-row input {
      width: 100%; padding: 14px 18px; font-size: 16px;
      border: 2px solid #e0e0e0; border-radius: 12px; outline: none;
      font-family: 'DM Sans', sans-serif; transition: border-color 0.2s;
      background: white;
    }
    .input-row input:focus { border-color: #4A7BF7; }

    .voice-toggle {
      padding: 14px 18px; border-radius: 12px;
      cursor: pointer; font-size: 14px; font-family: 'DM Sans', sans-serif;
      font-weight: 600; display: flex; align-items: center; gap: 8px;
      transition: all 0.2s;
    }

    .selected-bar {
      background: linear-gradient(135deg, #e3f2fd, #e8f0fe);
      border: 2px solid #4A7BF7; border-radius: 12px;
      padding: 14px 20px; margin-bottom: 20px;
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px; flex-wrap: wrap;
    }
    .selected-bar .info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .clear-btn {
      background: rgba(0,0,0,0.08); border: none; color: #666;
      width: 26px; height: 26px; border-radius: 50%; cursor: pointer;
      font-size: 13px; display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: background 0.15s;
    }
    .clear-btn:hover { background: rgba(220,50,50,0.15); }
    .notify-btn {
      padding: 10px 24px; border: none; border-radius: 10px;
      font-weight: 700; font-size: 14px; font-family: 'DM Sans', sans-serif;
      transition: transform 0.15s; flex-shrink: 0; cursor: pointer;
    }

    .group-section { margin-bottom: 28px; }
    .group-section h3 {
      font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;
      color: #888; margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
    }
    .group-section h3 .emoji { font-size: 18px; }
    .group-section h3 .count { color: #bbb; font-weight: 400; }
    .tile-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
    }
    .therapist-tile {
      padding: 24px 16px; border-radius: 16px; cursor: pointer;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex; flex-direction: column; align-items: center; gap: 10px;
      border: 3px solid transparent; position: relative;
    }
    .therapist-tile.selected { transform: scale(1.05); }
    .therapist-tile .avatar {
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700;
    }
    .therapist-tile .name { font-size: 14px; font-weight: 600; }
    .online-dot {
      position: absolute; top: 12px; right: 12px;
      width: 10px; height: 10px; border-radius: 50%;
      border: 2px solid white;
    }

    .recent-section h3 {
      font-size: 13px; text-transform: uppercase; letter-spacing: 1.5px;
      color: #999; margin-bottom: 12px;
    }
    .recent-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px; background: white; border-radius: 10px;
      font-size: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      margin-bottom: 8px;
    }
    .recent-item .tick { color: #43A047; }
    .recent-item .therapist-name { font-weight: 600; }
    .recent-item .arrow { color: #999; }
    .recent-item .time { margin-left: auto; color: #bbb; font-size: 12px; }

    /* ‚îÄ‚îÄ Therapist View ‚îÄ‚îÄ */
    .therapist-enable {
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center; padding: 32px;
    }
    .therapist-enable .bell { font-size: 36px; margin-bottom: 24px; }
    .therapist-enable h2 { font-size: 22px; font-weight: 700; margin-bottom: 8px; text-align: center; }
    .therapist-enable p { color: #888; margin-bottom: 28px; text-align: center; max-width: 360px; }
    .enable-btn {
      padding: 16px 40px; color: white; border: none; border-radius: 14px;
      font-size: 16px; font-weight: 700; cursor: pointer;
      font-family: 'DM Sans', sans-serif; transition: transform 0.15s;
    }
    .enable-btn:hover { transform: scale(1.05); }

    .therapist-header {
      padding: 28px 32px;
    }
    .therapist-header .row { display: flex; align-items: center; gap: 14px; }
    .therapist-header .avatar {
      width: 52px; height: 52px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; font-weight: 700;
    }
    .therapist-header h1 { margin: 0; font-size: 22px; font-weight: 700; }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #43e97b; animation: pulse 2s infinite;
    }
    .therapist-header .status {
      display: flex; align-items: center; gap: 8px; margin-top: 4px;
    }
    .therapist-header .status span { font-size: 13px; color: #999; }

    .therapist-body { padding: 32px; max-width: 600px; margin: 0 auto; }
    .waiting { text-align: center; padding-top: 80px; color: #bbb; }
    .waiting .icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
    .waiting p { font-size: 16px; }
    .waiting .hint { font-size: 13px; opacity: 0.6; }

    .arrival-item {
      display: flex; align-items: center; gap: 14px;
      padding: 16px 20px; background: white; border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 10px;
    }
    .arrival-item .wave {
      width: 40px; height: 40px; border-radius: 50%;
      background: linear-gradient(135deg, #43e97b33, #38f9d733);
      display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    .arrival-item .client-name { font-weight: 600; font-size: 15px; }
    .arrival-item .arrival-time { font-size: 12px; color: #999; }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed; top: -120px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: white; padding: 20px 32px; border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
      z-index: 9999; transition: top 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex; align-items: center; gap: 16px;
      max-width: 500px; width: 90vw;
    }
    .toast.visible { top: 24px; }
    .toast .bell-icon {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, #43e97b, #38f9d7);
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; flex-shrink: 0;
    }
    .toast .label { font-size: 13px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 4px; }
    .toast .client { font-size: 18px; font-weight: 700; }
    .toast .time { font-size: 13px; opacity: 0.6; margin-top: 2px; }
    .toast .dismiss {
      background: rgba(255,255,255,0.1); border: none; color: white;
      width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
    }

    /* ‚îÄ‚îÄ Switch Role Button ‚îÄ‚îÄ */
    .switch-btn {
      position: fixed; bottom: 20px; right: 20px;
      background: rgba(0,0,0,0.6); color: white; border: none;
      border-radius: 10px; padding: 10px 18px; font-size: 13px;
      cursor: pointer; font-family: 'DM Sans', sans-serif; z-index: 100;
    }

    /* ‚îÄ‚îÄ Connection Status ‚îÄ‚îÄ */
    .connection-status {
      position: fixed; top: 8px; right: 12px;
      padding: 4px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600; z-index: 100;
      display: flex; align-items: center; gap: 6px;
    }
    .connection-status.connected { background: #E8F5E9; color: #2E7D32; }
    .connection-status.disconnected { background: #FFEBEE; color: #C62828; }
    .connection-status .dot {
      width: 6px; height: 6px; border-radius: 50%;
    }
    .connection-status.connected .dot { background: #43A047; }
    .connection-status.disconnected .dot { background: #E53935; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>

<!-- ‚îÄ‚îÄ Toast Notification ‚îÄ‚îÄ -->
<div class="toast" id="toast">
  <div class="bell-icon">üîî</div>
  <div style="flex:1">
    <div class="label">Client Arrived</div>
    <div class="client" id="toast-client"></div>
    <div class="time" id="toast-time"></div>
  </div>
  <button class="dismiss" onclick="dismissToast()">‚úï</button>
</div>

<!-- ‚îÄ‚îÄ Connection Status ‚îÄ‚îÄ -->
<div class="connection-status" id="conn-status" style="display:none">
  <div class="dot"></div>
  <span id="conn-text"></span>
</div>

<!-- ‚îÄ‚îÄ All screens rendered here ‚îÄ‚îÄ -->
<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION ‚Äî Edit therapist names here
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const THERAPIST_GROUPS = [
  {
    label: "Speech Therapists",
    emoji: "üó£Ô∏è",
    names: ["Claire", "Izzy K", "Lauren", "Lily", "Rhys", "Sophie"]
  },
  {
    label: "Occupational Therapists",
    emoji: "ü§≤",
    names: ["Alice", "Ana", "Carl", "Chloe", "Elena", "Fernanda", "Isabel M", "Issy C", "Laura", "Valentina"]
  }
];

const ALL_THERAPISTS = THERAPIST_GROUPS.flatMap(g => g.names);

const TILE_COLORS = [
  { bg: "#E8F0FE", accent: "#4A7BF7", text: "#1A3A6B" },
  { bg: "#FDE8EF", accent: "#E84D8A", text: "#6B1A3A" },
  { bg: "#E8F5E9", accent: "#43A047", text: "#1B5E20" },
  { bg: "#FFF3E0", accent: "#FB8C00", text: "#E65100" },
  { bg: "#F3E5F5", accent: "#8E24AA", text: "#4A148C" },
  { bg: "#E0F7FA", accent: "#00ACC1", text: "#006064" },
  { bg: "#FCE4EC", accent: "#D81B60", text: "#880E4F" },
  { bg: "#E8EAF6", accent: "#5C6BC0", text: "#1A237E" },
  { bg: "#FFF8E1", accent: "#FFB300", text: "#FF6F00" },
  { bg: "#E0F2F1", accent: "#26A69A", text: "#004D40" },
  { bg: "#F1F8E9", accent: "#7CB342", text: "#33691E" },
  { bg: "#EDE7F6", accent: "#7E57C2", text: "#311B92" },
  { bg: "#FBE9E7", accent: "#F4511E", text: "#BF360C" },
  { bg: "#E1F5FE", accent: "#039BE5", text: "#01579B" },
  { bg: "#F9FBE7", accent: "#C0CA33", text: "#827717" },
  { bg: "#EFEBE9", accent: "#8D6E63", text: "#3E2723" },
  { bg: "#ECEFF1", accent: "#546E7A", text: "#263238" },
  { bg: "#FFF9C4", accent: "#FDD835", text: "#F57F17" },
  { bg: "#DCEDC8", accent: "#689F38", text: "#33691E" },
  { bg: "#D1C4E9", accent: "#7E57C2", text: "#4527A0" }
];

function getColor(name) {
  const i = ALL_THERAPISTS.indexOf(name);
  return TILE_COLORS[i >= 0 ? i % TILE_COLORS.length : 0];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentMode = null; // null | "reception" | therapist name
let ws = null;
let wsConnected = false;
let selectedTherapist = null;
let clientName = "";
let voiceEnabled = true;
let audioReady = false;
let recentSent = [];
let arrivalHistory = [];
let onlineTherapists = [];
let reconnectTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectWebSocket() {
  const protocol = location.protocol === "https:" ? "wss:" : "ws:";
  ws = new WebSocket(`${protocol}//${location.host}`);

  ws.onopen = () => {
    wsConnected = true;
    updateConnectionStatus();

    // Re-register on reconnect
    if (currentMode === "reception") {
      ws.send(JSON.stringify({ type: "register-reception" }));
    } else if (currentMode && currentMode !== "reception") {
      ws.send(JSON.stringify({ type: "register-therapist", name: currentMode }));
    }
  };

  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if (msg.type === "arrival") {
      // Therapist received notification
      arrivalHistory.unshift(msg);
      showToast(msg.clientName, msg.time);
      playDingSound();
      if (msg.voiceEnabled) {
        setTimeout(() => speakAnnouncement(currentMode, msg.clientName), 900);
      }
      render();
    }

    if (msg.type === "notify-confirmed") {
      recentSent.unshift(msg);
      if (recentSent.length > 20) recentSent.pop();
      render();
    }

    if (msg.type === "online-list") {
      onlineTherapists = msg.online;
      render();
    }
  };

  ws.onclose = () => {
    wsConnected = false;
    updateConnectionStatus();
    // Auto-reconnect after 2 seconds
    clearTimeout(reconnectTimer);
    reconnectTimer = setTimeout(connectWebSocket, 2000);
  };

  ws.onerror = () => {
    ws.close();
  };
}

function updateConnectionStatus() {
  const el = document.getElementById("conn-status");
  const text = document.getElementById("conn-text");
  if (currentMode) {
    el.style.display = "flex";
    if (wsConnected) {
      el.className = "connection-status connected";
      text.textContent = "Connected";
    } else {
      el.className = "connection-status disconnected";
      text.textContent = "Reconnecting...";
    }
  } else {
    el.style.display = "none";
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function playDingSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const t = ctx.currentTime;
    const fund = 1500;

    // Bell partials (inharmonic ratios for metallic character)
    [
      { ratio: 1, vol: 0.5, decay: 1.9 },
      { ratio: 1.67, vol: 0.35, decay: 1.5 },
      { ratio: 2.83, vol: 0.2, decay: 1.0 },
      { ratio: 4.12, vol: 0.15, decay: 0.65 },
      { ratio: 5.58, vol: 0.08, decay: 0.4 },
      { ratio: 7.41, vol: 0.04, decay: 0.25 },
    ].forEach(p => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(fund * p.ratio, t);
      osc.frequency.setValueAtTime(fund * p.ratio * 1.001, t + 0.05);
      gain.gain.setValueAtTime(p.vol, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + p.decay);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);
      osc.stop(t + p.decay);
    });

    // Detune shimmer for metallic beating
    [
      { ratio: 1.004, vol: 0.22, decay: 1.6 },
      { ratio: 1.674, vol: 0.13, decay: 1.3 },
    ].forEach(p => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(fund * p.ratio, t);
      gain.gain.setValueAtTime(p.vol, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + p.decay);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);
      osc.stop(t + p.decay);
    });

    // Sub layers for thickness
    [
      { freq: 750, vol: 0.22, decay: 1.5 },
      { freq: 375, vol: 0.15, decay: 1.2 },
    ].forEach(s => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(s.freq, t);
      gain.gain.setValueAtTime(s.vol, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + s.decay);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(t);
      osc.stop(t + s.decay);
    });

    // Strike impact
    const bufferSize = ctx.sampleRate * 0.03;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) {
      data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / bufferSize, 3);
    }
    const noise = ctx.createBufferSource();
    const noiseGain = ctx.createGain();
    const noiseFilter = ctx.createBiquadFilter();
    noiseFilter.type = "bandpass";
    noiseFilter.frequency.value = fund * 1.67;
    noiseFilter.Q.value = 1;
    noise.buffer = buffer;
    noiseGain.gain.setValueAtTime(0.38, t);
    noise.connect(noiseFilter);
    noiseFilter.connect(noiseGain);
    noiseGain.connect(ctx.destination);
    noise.start(t);
  } catch (e) {}
}

function speakAnnouncement(therapistName, clientName) {
  try {
    const text = clientName
      ? `${therapistName}, your client ${clientName} is here`
      : `${therapistName}, your client is here`;
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95; u.pitch = 1.05; u.volume = 1;
    const voices = window.speechSynthesis.getVoices();
    const pref = voices.find(v => v.lang.startsWith("en") && v.name.toLowerCase().includes("female"))
      || voices.find(v => v.lang.startsWith("en"));
    if (pref) u.voice = pref;
    window.speechSynthesis.speak(u);
  } catch (e) {}
}

function enableAudio() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(0, ctx.currentTime);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 0.01);
  } catch (e) {}
  try { window.speechSynthesis.getVoices(); } catch (e) {}
  audioReady = true;
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer = null;
function showToast(client, time) {
  const toast = document.getElementById("toast");
  document.getElementById("toast-client").textContent = client || "Client arrived";
  document.getElementById("toast-time").textContent = new Date(time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  clearTimeout(toastTimer);
  requestAnimationFrame(() => toast.classList.add("visible"));
  toastTimer = setTimeout(dismissToast, 8000);
}
function dismissToast() {
  document.getElementById("toast").classList.remove("visible");
  clearTimeout(toastTimer);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectMode(mode) {
  currentMode = mode;

  if (!ws || ws.readyState !== WebSocket.OPEN) {
    connectWebSocket();
    // Wait for connection, then register
    const check = setInterval(() => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        clearInterval(check);
        registerRole();
        render();
      }
    }, 100);
  } else {
    registerRole();
  }
  render();
  updateConnectionStatus();
}

function registerRole() {
  if (currentMode === "reception") {
    ws.send(JSON.stringify({ type: "register-reception" }));
  } else {
    ws.send(JSON.stringify({ type: "register-therapist", name: currentMode }));
  }
}

function switchRole() {
  if (ws) ws.close();
  currentMode = null;
  selectedTherapist = null;
  clientName = "";
  recentSent = [];
  arrivalHistory = [];
  onlineTherapists = [];
  audioReady = false;
  wsConnected = false;
  updateConnectionStatus();
  render();
}

function selectTherapist(name) {
  selectedTherapist = selectedTherapist === name ? null : name;
  render();
}

function clearSelection() {
  selectedTherapist = null;
  render();
}

function setClientName(val) {
  clientName = val;
  // Don't re-render the whole page, just update the bar
}

function toggleVoice() {
  voiceEnabled = !voiceEnabled;
  render();
}

function sendNotification(withVoice) {
  if (!selectedTherapist || !ws) return;
  ws.send(JSON.stringify({
    type: "notify",
    therapist: selectedTherapist,
    clientName: clientName.trim() || "",
    voiceEnabled: withVoice
  }));
  clientName = "";
  selectedTherapist = null;
  render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const app = document.getElementById("app");

  if (!currentMode) {
    app.innerHTML = renderModeSelect();
    return;
  }
  if (currentMode === "reception") {
    app.innerHTML = renderReception();
    // Restore input value
    const input = document.getElementById("client-input");
    if (input) input.value = clientName;
    return;
  }
  // Therapist view
  if (!audioReady) {
    app.innerHTML = renderTherapistEnable();
  } else {
    app.innerHTML = renderTherapistView();
  }
}

function renderModeSelect() {
  let groupsHtml = THERAPIST_GROUPS.map(group => {
    const namesHtml = group.names.map(name => {
      const c = getColor(name);
      return `<button class="name-btn" style="background:${c.bg};border-color:${c.accent}33;color:${c.text}"
        onmouseover="this.style.borderColor='${c.accent}';this.style.transform='scale(1.05)'"
        onmouseout="this.style.borderColor='${c.accent}33';this.style.transform='scale(1)'"
        onclick="selectMode('${name}')">${name}</button>`;
    }).join("");
    return `
      <div class="group-label"><span class="emoji">${group.emoji}</span>${group.label}</div>
      <div class="group-grid">${namesHtml}</div>`;
  }).join("");

  return `
    <div class="mode-select">
      <div class="logo">üè•</div>
      <h1>Client Arrival Notifier</h1>
      <p class="subtitle">Choose your role to get started. Reception sends notifications; therapists receive them.</p>
      <button class="reception-btn" onclick="selectMode('reception')">
        <span class="icon">üñ•Ô∏è</span>
        <div class="label">
          <div>Reception Dashboard</div>
          <div class="sublabel">Send arrival notifications to therapists</div>
        </div>
      </button>
      <div class="divider"><span>OR</span></div>
      <div class="therapist-select">
        <div class="heading">I'm a therapist ‚Äî select your name</div>
        ${groupsHtml}
      </div>
    </div>`;
}

function renderReception() {
  let selectedBar = "";
  if (selectedTherapist) {
    const clientDisplay = clientName.trim() ? ` <span style="color:#666">‚Äî Client: ${clientName.trim()}</span>` : "";
    selectedBar = `
      <div class="selected-bar" style="flex-direction:column">
        <div style="display:flex;align-items:center;gap:10px;width:100%">
          <span>Notifying: <strong style="color:#1A3A6B">${selectedTherapist}</strong>${clientDisplay}</span>
          <button class="clear-btn" onclick="clearSelection()" title="Clear selection">‚úï</button>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button class="notify-btn" style="background:linear-gradient(135deg,#43e97b,#38d9a9);color:#fff;cursor:pointer;padding:12px 24px" onclick="sendNotification(false)">
            üîî Ding Only
          </button>
          <button class="notify-btn" style="background:linear-gradient(135deg,#4A7BF7,#5C6BC0);color:#fff;cursor:pointer;padding:12px 24px" onclick="sendNotification(true)">
            üîä Ding + Voice
          </button>
        </div>
      </div>`;
  }

  const groupsHtml = THERAPIST_GROUPS.map(group => {
    const tilesHtml = group.names.map(name => {
      const c = getColor(name);
      const isSelected = selectedTherapist === name;
      const isOnline = onlineTherapists.includes(name);
      const borderStyle = isSelected ? `border-color:${c.accent}` : "";
      const bgStyle = isSelected ? `background:linear-gradient(135deg,${c.bg},white)` : `background:${c.bg}`;
      const shadowStyle = isSelected ? `box-shadow:0 8px 25px ${c.accent}33` : "box-shadow:0 2px 8px rgba(0,0,0,0.04)";
      const transformStyle = isSelected ? "transform:scale(1.05)" : "";
      const onlineDot = `<div class="online-dot" style="background:${isOnline ? '#43e97b' : '#ddd'}"></div>`;
      return `
        <div class="therapist-tile ${isSelected ? 'selected' : ''}"
          style="${borderStyle};${bgStyle};${shadowStyle};${transformStyle}"
          onclick="selectTherapist('${name}')">
          ${onlineDot}
          <div class="avatar" style="background:linear-gradient(135deg,${c.accent}22,${c.accent}44);color:${c.accent}">
            ${name.charAt(0)}
          </div>
          <div class="name" style="color:${c.text}">${name}</div>
        </div>`;
    }).join("");
    return `
      <div class="group-section">
        <h3><span class="emoji">${group.emoji}</span>${group.label}<span class="count">(${group.names.length})</span></h3>
        <div class="tile-grid">${tilesHtml}</div>
      </div>`;
  }).join("");

  const recentHtml = recentSent.length > 0 ? `
    <div class="recent-section">
      <h3>Recent Notifications</h3>
      ${recentSent.map(n => `
        <div class="recent-item">
          <span class="tick">‚úì</span>
          <span class="therapist-name">${n.therapist}</span>
          <span class="arrow">‚Üê</span>
          <span>${n.clientName || "Ding only"}</span>
          <span class="time">${new Date(n.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</span>
        </div>`).join("")}
    </div>` : "";

  return `
    <div class="reception-header">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
        <span style="font-size:28px">üè•</span>
        <h1>Reception Dashboard</h1>
      </div>
      <p class="sub">Tap a therapist and choose ding only or ding + voice</p>
    </div>
    <div class="reception-body">
      <div class="input-row">
        <div class="field">
          <label>Client Name <span style="font-weight:400;color:#aaa">(optional)</span></label>
          <input type="text" id="client-input" placeholder="Enter client's name..."
            oninput="setClientName(this.value)"
            onkeydown="if(event.key==='Enter')sendNotification(false)">
        </div>
      </div>
      ${selectedBar}
      ${groupsHtml}
      ${recentHtml}
    </div>
    <button class="switch-btn" onclick="switchRole()">‚Üê Switch Role</button>`;
}

function renderTherapistEnable() {
  const c = getColor(currentMode);
  return `
    <div class="therapist-enable" style="background:linear-gradient(135deg,${c.bg},white)">
      <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,${c.accent}33,${c.accent}66);
        display:flex;align-items:center;justify-content:center;font-size:36px;margin-bottom:24px">üîî</div>
      <h2 style="color:${c.text}">Welcome, ${currentMode}</h2>
      <p>Your browser needs a click to enable notification sounds and voice announcements. Tap below to start listening.</p>
      <button class="enable-btn" style="background:linear-gradient(135deg,${c.accent},${c.accent}cc);
        box-shadow:0 8px 30px ${c.accent}44" onclick="enableAudio()">üîä Enable Notifications</button>
    </div>
    <button class="switch-btn" onclick="switchRole()">‚Üê Switch Role</button>`;
}

function renderTherapistView() {
  const c = getColor(currentMode);

  const historyHtml = arrivalHistory.length === 0
    ? `<div class="waiting">
        <div class="icon">üîî</div>
        <p>Waiting for reception to notify you...</p>
        <p class="hint">Keep this tab open ‚Äî you'll hear a ding when a client arrives</p>
      </div>`
    : `<h3 style="font-size:13px;text-transform:uppercase;letter-spacing:1.5px;color:#999;margin-bottom:16px">
        Today's Arrivals
      </h3>
      ${arrivalHistory.map(n => `
        <div class="arrival-item">
          <div class="wave">üëã</div>
          <div style="flex:1">
            <div class="client-name">${n.clientName || "Client arrived"}</div>
            <div class="arrival-time">Arrived at ${new Date(n.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
          </div>
        </div>`).join("")}`;

  return `
    <div style="min-height:100vh;background:linear-gradient(135deg,${c.bg},white)">
      <div class="therapist-header" style="border-bottom:2px solid ${c.accent}22">
        <div class="row">
          <div class="avatar" style="background:linear-gradient(135deg,${c.accent}33,${c.accent}66);color:${c.accent}">
            ${currentMode.charAt(0)}
          </div>
          <div>
            <h1 style="color:${c.text}">${currentMode}'s Notifications</h1>
            <div class="status">
              <div class="status-dot"></div>
              <span>Listening for arrivals...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="therapist-body">
        ${historyHtml}
      </div>
    </div>
    <button class="switch-btn" onclick="switchRole()">‚Üê Switch Role</button>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
render();
// Pre-load voices for speech synthesis
if (window.speechSynthesis) {
  window.speechSynthesis.getVoices();
  window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
}
</script>
</body>
</html>
